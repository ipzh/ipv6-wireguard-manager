<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API路径构建器测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .test-pass {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">API路径构建器测试</h1>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>测试控制</h5>
                    </div>
                    <div class="card-body">
                        <button id="runTests" class="btn btn-primary">运行所有测试</button>
                        <button id="clearResults" class="btn btn-secondary">清除结果</button>
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="verboseOutput" checked>
                                <label class="form-check-label" for="verboseOutput">详细输出</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>测试结果</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults">
                            <div class="test-info">
                                点击"运行所有测试"按钮开始测试API路径构建器。
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>测试统计</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="totalTests">0</h4>
                                    <p class="text-muted">总测试数</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="passedTests">0</h4>
                                    <p class="text-muted">通过测试</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="failedTests">0</h4>
                                    <p class="text-muted">失败测试</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="successRate">0%</h4>
                                    <p class="text-muted">成功率</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { apiPathBuilder } from './config/api_endpoints.js';
        
        // 测试结果
        let testResults = {};
        let totalTests = 0;
        let passedTests = 0;
        
        // DOM元素
        const testResultsDiv = document.getElementById('testResults');
        const totalTestsSpan = document.getElementById('totalTests');
        const passedTestsSpan = document.getElementById('passedTests');
        const failedTestsSpan = document.getElementById('failedTests');
        const successRateSpan = document.getElementById('successRate');
        const verboseOutputCheckbox = document.getElementById('verboseOutput');
        
        // 运行所有测试
        document.getElementById('runTests').addEventListener('click', function() {
            clearResults();
            runAllTests();
        });
        
        // 清除结果
        document.getElementById('clearResults').addEventListener('click', function() {
            clearResults();
        });
        
        // 清除测试结果
        function clearResults() {
            testResults = {};
            totalTests = 0;
            passedTests = 0;
            updateStatistics();
            testResultsDiv.innerHTML = '<div class="test-info">测试已清除，点击"运行所有测试"按钮开始测试。</div>';
        }
        
        // 更新统计信息
        function updateStatistics() {
            totalTestsSpan.textContent = totalTests;
            passedTestsSpan.textContent = passedTests;
            failedTestsSpan.textContent = totalTests - passedTests;
            const successRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;
            successRateSpan.textContent = successRate + '%';
        }
        
        // 添加测试结果
        function addTestResult(category, testName, success, details = null) {
            if (!testResults[category]) {
                testResults[category] = [];
            }
            
            testResults[category].push({
                name: testName,
                success: success,
                details: details
            });
            
            totalTests++;
            if (success) {
                passedTests++;
            }
            
            updateStatistics();
            
            // 显示测试结果
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${success ? 'test-pass' : 'test-fail'}`;
            
            let content = `<strong>${category} - ${testName}</strong>: ${success ? '通过' : '失败'}`;
            
            if (details && verboseOutputCheckbox.checked) {
                content += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
            
            resultDiv.innerHTML = content;
            testResultsDiv.appendChild(resultDiv);
        }
        
        // 运行所有测试
        async function runAllTests() {
            testResultsDiv.innerHTML = '<div class="test-info">正在运行测试...</div>';
            
            // 测试基本路径构建
            testBasicPathBuilding();
            
            // 测试路径参数处理
            testPathParameters();
            
            // 测试路径验证
            testPathValidation();
            
            // 测试路径生成
            testPathGeneration();
            
            // 显示总结
            setTimeout(() => {
                const successRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;
                let summaryClass = 'test-info';
                let summaryMessage = '测试完成';
                
                if (successRate >= 95) {
                    summaryClass = 'test-pass';
                    summaryMessage = '🎉 API路径构建器测试通过！系统可以正常使用。';
                } else if (successRate >= 80) {
                    summaryClass = 'test-info';
                    summaryMessage = '⚠️ API路径构建器基本正常，但有一些问题需要关注。';
                } else {
                    summaryClass = 'test-fail';
                    summaryMessage = '❌ API路径构建器存在严重问题，需要修复。';
                }
                
                const summaryDiv = document.createElement('div');
                summaryDiv.className = `test-result ${summaryClass}`;
                summaryDiv.innerHTML = `<h5>${summaryMessage}</h5>`;
                testResultsDiv.appendChild(summaryDiv);
            }, 100);
        }
        
        // 测试基本路径构建
        function testBasicPathBuilding() {
            try {
                // 测试基本路径构建
                const loginPath = apiPathBuilder.buildUrl('auth.login');
                addTestResult(
                    '基本路径构建',
                    '登录路径',
                    loginPath === 'http://localhost:8000/api/auth/login',
                    { expected: 'http://localhost:8000/api/auth/login', actual: loginPath }
                );
                
                // 测试带参数的路径构建
                const userPath = apiPathBuilder.buildUrl('users.get', { user_id: 123 });
                addTestResult(
                    '基本路径构建',
                    '用户路径',
                    userPath === 'http://localhost:8000/api/users/123',
                    { expected: 'http://localhost:8000/api/users/123', actual: userPath }
                );
                
                // 测试完整URL构建
                const serverUrl = apiPathBuilder.buildUrl('wireguard.servers.get', { server_id: 'wg-01' });
                addTestResult(
                    '基本路径构建',
                    'WireGuard服务器URL',
                    serverUrl === 'http://localhost:8000/api/wireguard/servers/wg-01',
                    { expected: 'http://localhost:8000/api/wireguard/servers/wg-01', actual: serverUrl }
                );
            } catch (error) {
                addTestResult(
                    '基本路径构建',
                    '异常处理',
                    false,
                    { error: error.message }
                );
            }
        }
        
        // 测试路径参数处理
        function testPathParameters() {
            try {
                // 测试单个参数
                const singleParam = apiPathBuilder.buildUrl('users.get', { user_id: 123 });
                addTestResult(
                    '路径参数处理',
                    '单个参数',
                    singleParam === 'http://localhost:8000/api/users/123',
                    { expected: 'http://localhost:8000/api/users/123', actual: singleParam }
                );
                
                // 测试多个参数
                const multiParam = apiPathBuilder.buildUrl('wireguard.clients.config', {
                    server_id: 'wg-01',
                    client_id: 'client-123'
                });
                addTestResult(
                    '路径参数处理',
                    '多个参数',
                    multiParam === 'http://localhost:8000/api/wireguard/servers/wg-01/clients/client-123/config',
                    { expected: 'http://localhost:8000/api/wireguard/servers/wg-01/clients/client-123/config', actual: multiParam }
                );
                
                // 测试额外参数
                const extraParam = apiPathBuilder.buildUrl('users.get', {
                    user_id: 123,
                    extra_param: 'value'
                });
                addTestResult(
                    '路径参数处理',
                    '额外参数',
                    extraParam === 'http://localhost:8000/api/users/123',
                    { expected: 'http://localhost:8000/api/users/123', actual: extraParam }
                );
            } catch (error) {
                addTestResult(
                    '路径参数处理',
                    '异常处理',
                    false,
                    { error: error.message }
                );
            }
        }
        
        // 测试路径验证
        function testPathValidation() {
            try {
                // 测试有效路径
                const validPaths = [
                    'auth.login',
                    'users.list',
                    'wireguard.servers.list',
                    'bgp.sessions.list',
                    'ipv6.pools.list',
                    'system.info'
                ];
                
                validPaths.forEach(pathName => {
                    const isValid = apiPathBuilder.validatePath(pathName);
                    addTestResult(
                        '路径验证',
                        `有效路径: ${pathName}`,
                        isValid === true,
                        { path: pathName, result: isValid }
                    );
                });
                
                // 测试无效路径
                const invalidPaths = [
                    'invalid.path',
                    'auth.invalid',
                    'users.invalid.action',
                    'nonexistent.module.path'
                ];
                
                invalidPaths.forEach(pathName => {
                    const isValid = apiPathBuilder.validatePath(pathName);
                    addTestResult(
                        '路径验证',
                        `无效路径: ${pathName}`,
                        isValid === false,
                        { path: pathName, result: isValid }
                    );
                });
            } catch (error) {
                addTestResult(
                    '路径验证',
                    '异常处理',
                    false,
                    { error: error.message }
                );
            }
        }
        
        // 测试路径生成
        function testPathGeneration() {
            try {
                // 测试不同模块的路径生成
                const modules = {
                    'auth': ['login', 'logout', 'refresh', 'me'],
                    'users': ['list', 'get', 'create', 'update', 'delete'],
                    'wireguard.servers': ['list', 'get', 'create', 'update', 'delete', 'status'],
                    'bgp.sessions': ['list', 'get', 'create', 'update', 'delete', 'status'],
                    'ipv6.pools': ['list', 'get', 'create', 'update', 'delete'],
                    'system': ['info', 'status', 'health', 'metrics']
                };
                
                Object.keys(modules).forEach(module => {
                    modules[module].forEach(action => {
                        const pathName = `${module}.${action}`;
                        try {
                            const path = apiPathBuilder.buildUrl(pathName);
                            addTestResult(
                                '路径生成',
                                pathName,
                                !path.includes('{') && !path.includes('}'),
                                { path: path }
                            );
                        } catch (error) {
                            addTestResult(
                                '路径生成',
                                pathName,
                                false,
                                { error: error.message }
                            );
                        }
                    });
                });
            } catch (error) {
                addTestResult(
                    '路径生成',
                    '异常处理',
                    false,
                    { error: error.message }
                );
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIè·¯å¾„æ„å»ºå™¨æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .test-pass {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">APIè·¯å¾„æ„å»ºå™¨æµ‹è¯•</h1>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•æ§åˆ¶</h5>
                    </div>
                    <div class="card-body">
                        <button id="runTests" class="btn btn-primary">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
                        <button id="clearResults" class="btn btn-secondary">æ¸…é™¤ç»“æœ</button>
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="verboseOutput" checked>
                                <label class="form-check-label" for="verboseOutput">è¯¦ç»†è¾“å‡º</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•ç»“æœ</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults">
                            <div class="test-info">
                                ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•APIè·¯å¾„æ„å»ºå™¨ã€‚
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•ç»Ÿè®¡</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="totalTests">0</h4>
                                    <p class="text-muted">æ€»æµ‹è¯•æ•°</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="passedTests">0</h4>
                                    <p class="text-muted">é€šè¿‡æµ‹è¯•</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="failedTests">0</h4>
                                    <p class="text-muted">å¤±è´¥æµ‹è¯•</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="successRate">0%</h4>
                                    <p class="text-muted">æˆåŠŸç‡</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { apiPathBuilder } from './config/api_endpoints.js';
        
        // æµ‹è¯•ç»“æœ
        let testResults = {};
        let totalTests = 0;
        let passedTests = 0;
        
        // DOMå…ƒç´ 
        const testResultsDiv = document.getElementById('testResults');
        const totalTestsSpan = document.getElementById('totalTests');
        const passedTestsSpan = document.getElementById('passedTests');
        const failedTestsSpan = document.getElementById('failedTests');
        const successRateSpan = document.getElementById('successRate');
        const verboseOutputCheckbox = document.getElementById('verboseOutput');
        
        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        document.getElementById('runTests').addEventListener('click', function() {
            clearResults();
            runAllTests();
        });
        
        // æ¸…é™¤ç»“æœ
        document.getElementById('clearResults').addEventListener('click', function() {
            clearResults();
        });
        
        // æ¸…é™¤æµ‹è¯•ç»“æœ
        function clearResults() {
            testResults = {};
            totalTests = 0;
            passedTests = 0;
            updateStatistics();
            testResultsDiv.innerHTML = '<div class="test-info">æµ‹è¯•å·²æ¸…é™¤ï¼Œç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•ã€‚</div>';
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            totalTestsSpan.textContent = totalTests;
            passedTestsSpan.textContent = passedTests;
            failedTestsSpan.textContent = totalTests - passedTests;
            const successRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;
            successRateSpan.textContent = successRate + '%';
        }
        
        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(category, testName, success, details = null) {
            if (!testResults[category]) {
                testResults[category] = [];
            }
            
            testResults[category].push({
                name: testName,
                success: success,
                details: details
            });
            
            totalTests++;
            if (success) {
                passedTests++;
            }
            
            updateStatistics();
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${success ? 'test-pass' : 'test-fail'}`;
            
            let content = `<strong>${category} - ${testName}</strong>: ${success ? 'é€šè¿‡' : 'å¤±è´¥'}`;
            
            if (details && verboseOutputCheckbox.checked) {
                content += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
            
            resultDiv.innerHTML = content;
            testResultsDiv.appendChild(resultDiv);
        }
        
        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            testResultsDiv.innerHTML = '<div class="test-info">æ­£åœ¨è¿è¡Œæµ‹è¯•...</div>';
            
            // æµ‹è¯•åŸºæœ¬è·¯å¾„æ„å»º
            testBasicPathBuilding();
            
            // æµ‹è¯•è·¯å¾„å‚æ•°å¤„ç†
            testPathParameters();
            
            // æµ‹è¯•è·¯å¾„éªŒè¯
            testPathValidation();
            
            // æµ‹è¯•è·¯å¾„ç”Ÿæˆ
            testPathGeneration();
            
            // æ˜¾ç¤ºæ€»ç»“
            setTimeout(() => {
                const successRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;
                let summaryClass = 'test-info';
                let summaryMessage = 'æµ‹è¯•å®Œæˆ';
                
                if (successRate >= 95) {
                    summaryClass = 'test-pass';
                    summaryMessage = 'ğŸ‰ APIè·¯å¾„æ„å»ºå™¨æµ‹è¯•é€šè¿‡ï¼ç³»ç»Ÿå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚';
                } else if (successRate >= 80) {
                    summaryClass = 'test-info';
                    summaryMessage = 'âš ï¸ APIè·¯å¾„æ„å»ºå™¨åŸºæœ¬æ­£å¸¸ï¼Œä½†æœ‰ä¸€äº›é—®é¢˜éœ€è¦å…³æ³¨ã€‚';
                } else {
                    summaryClass = 'test-fail';
                    summaryMessage = 'âŒ APIè·¯å¾„æ„å»ºå™¨å­˜åœ¨ä¸¥é‡é—®é¢˜ï¼Œéœ€è¦ä¿®å¤ã€‚';
                }
                
                const summaryDiv = document.createElement('div');
                summaryDiv.className = `test-result ${summaryClass}`;
                summaryDiv.innerHTML = `<h5>${summaryMessage}</h5>`;
                testResultsDiv.appendChild(summaryDiv);
            }, 100);
        }
        
        // æµ‹è¯•åŸºæœ¬è·¯å¾„æ„å»º
        function testBasicPathBuilding() {
            try {
                // æµ‹è¯•åŸºæœ¬è·¯å¾„æ„å»º
                const loginPath = apiPathBuilder.buildUrl('auth.login');
                addTestResult(
                    'åŸºæœ¬è·¯å¾„æ„å»º',
                    'ç™»å½•è·¯å¾„',
                    loginPath === 'http://localhost:8000/api/auth/login',
                    { expected: 'http://localhost:8000/api/auth/login', actual: loginPath }
                );
                
                // æµ‹è¯•å¸¦å‚æ•°çš„è·¯å¾„æ„å»º
                const userPath = apiPathBuilder.buildUrl('users.get', { user_id: 123 });
                addTestResult(
                    'åŸºæœ¬è·¯å¾„æ„å»º',
                    'ç”¨æˆ·è·¯å¾„',
                    userPath === 'http://localhost:8000/api/users/123',
                    { expected: 'http://localhost:8000/api/users/123', actual: userPath }
                );
                
                // æµ‹è¯•å®Œæ•´URLæ„å»º
                const serverUrl = apiPathBuilder.buildUrl('wireguard.servers.get', { server_id: 'wg-01' });
                addTestResult(
                    'åŸºæœ¬è·¯å¾„æ„å»º',
                    'WireGuardæœåŠ¡å™¨URL',
                    serverUrl === 'http://localhost:8000/api/wireguard/servers/wg-01',
                    { expected: 'http://localhost:8000/api/wireguard/servers/wg-01', actual: serverUrl }
                );
            } catch (error) {
                addTestResult(
                    'åŸºæœ¬è·¯å¾„æ„å»º',
                    'å¼‚å¸¸å¤„ç†',
                    false,
                    { error: error.message }
                );
            }
        }
        
        // æµ‹è¯•è·¯å¾„å‚æ•°å¤„ç†
        function testPathParameters() {
            try {
                // æµ‹è¯•å•ä¸ªå‚æ•°
                const singleParam = apiPathBuilder.buildUrl('users.get', { user_id: 123 });
                addTestResult(
                    'è·¯å¾„å‚æ•°å¤„ç†',
                    'å•ä¸ªå‚æ•°',
                    singleParam === 'http://localhost:8000/api/users/123',
                    { expected: 'http://localhost:8000/api/users/123', actual: singleParam }
                );
                
                // æµ‹è¯•å¤šä¸ªå‚æ•°
                const multiParam = apiPathBuilder.buildUrl('wireguard.clients.config', {
                    server_id: 'wg-01',
                    client_id: 'client-123'
                });
                addTestResult(
                    'è·¯å¾„å‚æ•°å¤„ç†',
                    'å¤šä¸ªå‚æ•°',
                    multiParam === 'http://localhost:8000/api/wireguard/servers/wg-01/clients/client-123/config',
                    { expected: 'http://localhost:8000/api/wireguard/servers/wg-01/clients/client-123/config', actual: multiParam }
                );
                
                // æµ‹è¯•é¢å¤–å‚æ•°
                const extraParam = apiPathBuilder.buildUrl('users.get', {
                    user_id: 123,
                    extra_param: 'value'
                });
                addTestResult(
                    'è·¯å¾„å‚æ•°å¤„ç†',
                    'é¢å¤–å‚æ•°',
                    extraParam === 'http://localhost:8000/api/users/123',
                    { expected: 'http://localhost:8000/api/users/123', actual: extraParam }
                );
            } catch (error) {
                addTestResult(
                    'è·¯å¾„å‚æ•°å¤„ç†',
                    'å¼‚å¸¸å¤„ç†',
                    false,
                    { error: error.message }
                );
            }
        }
        
        // æµ‹è¯•è·¯å¾„éªŒè¯
        function testPathValidation() {
            try {
                // æµ‹è¯•æœ‰æ•ˆè·¯å¾„
                const validPaths = [
                    'auth.login',
                    'users.list',
                    'wireguard.servers.list',
                    'bgp.sessions.list',
                    'ipv6.pools.list',
                    'system.info'
                ];
                
                validPaths.forEach(pathName => {
                    const isValid = apiPathBuilder.validatePath(pathName);
                    addTestResult(
                        'è·¯å¾„éªŒè¯',
                        `æœ‰æ•ˆè·¯å¾„: ${pathName}`,
                        isValid === true,
                        { path: pathName, result: isValid }
                    );
                });
                
                // æµ‹è¯•æ— æ•ˆè·¯å¾„
                const invalidPaths = [
                    'invalid.path',
                    'auth.invalid',
                    'users.invalid.action',
                    'nonexistent.module.path'
                ];
                
                invalidPaths.forEach(pathName => {
                    const isValid = apiPathBuilder.validatePath(pathName);
                    addTestResult(
                        'è·¯å¾„éªŒè¯',
                        `æ— æ•ˆè·¯å¾„: ${pathName}`,
                        isValid === false,
                        { path: pathName, result: isValid }
                    );
                });
            } catch (error) {
                addTestResult(
                    'è·¯å¾„éªŒè¯',
                    'å¼‚å¸¸å¤„ç†',
                    false,
                    { error: error.message }
                );
            }
        }
        
        // æµ‹è¯•è·¯å¾„ç”Ÿæˆ
        function testPathGeneration() {
            try {
                // æµ‹è¯•ä¸åŒæ¨¡å—çš„è·¯å¾„ç”Ÿæˆ
                const modules = {
                    'auth': ['login', 'logout', 'refresh', 'me'],
                    'users': ['list', 'get', 'create', 'update', 'delete'],
                    'wireguard.servers': ['list', 'get', 'create', 'update', 'delete', 'status'],
                    'bgp.sessions': ['list', 'get', 'create', 'update', 'delete', 'status'],
                    'ipv6.pools': ['list', 'get', 'create', 'update', 'delete'],
                    'system': ['info', 'status', 'health', 'metrics']
                };
                
                Object.keys(modules).forEach(module => {
                    modules[module].forEach(action => {
                        const pathName = `${module}.${action}`;
                        try {
                            const path = apiPathBuilder.buildUrl(pathName);
                            addTestResult(
                                'è·¯å¾„ç”Ÿæˆ',
                                pathName,
                                !path.includes('{') && !path.includes('}'),
                                { path: path }
                            );
                        } catch (error) {
                            addTestResult(
                                'è·¯å¾„ç”Ÿæˆ',
                                pathName,
                                false,
                                { error: error.message }
                            );
                        }
                    });
                });
            } catch (error) {
                addTestResult(
                    'è·¯å¾„ç”Ÿæˆ',
                    'å¼‚å¸¸å¤„ç†',
                    false,
                    { error: error.message }
                );
            }
        }
    </script>
</body>
</html>
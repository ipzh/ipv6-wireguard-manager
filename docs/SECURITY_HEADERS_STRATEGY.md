# å®‰å…¨å¤´è®¾ç½®ç­–ç•¥æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜IPv6 WireGuard Managerç³»ç»Ÿä¸­å®‰å…¨å¤´çš„è®¾ç½®ç­–ç•¥ï¼Œå¸®åŠ©å¼€å‘è€…å’Œè¿ç»´äººå‘˜ç†è§£ä¸åŒç¯å¢ƒä¸‹å®‰å…¨å¤´çš„é…ç½®æ–¹å¼ã€‚

**æœ€åæ›´æ–°**: 2024å¹´12æœˆ  
**ç‰ˆæœ¬**: 1.0

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### åŸåˆ™1: å•ä¸€æ¥æºè®¾ç½®
- âœ… **æ¨è**: åœ¨ä¸€ä¸ªåœ°æ–¹ç»Ÿä¸€è®¾ç½®å®‰å…¨å¤´
- âŒ **é¿å…**: åœ¨å¤šä¸ªå±‚ï¼ˆNginxã€FastAPIã€PHPï¼‰é‡å¤è®¾ç½®

### åŸåˆ™2: ä¼˜å…ˆçº§ç­–ç•¥
```
Nginx (æœ€é«˜ä¼˜å…ˆçº§) > FastAPIä¸­é—´ä»¶ (å¤‡é€‰) > PHP (å·²ç§»é™¤)
```

### åŸåˆ™3: ç¯å¢ƒé€‚é…
- **ç”Ÿäº§ç¯å¢ƒ**: Nginxç»Ÿä¸€è®¾ç½®ï¼ˆæ¨èï¼‰
- **å¼€å‘ç¯å¢ƒ**: FastAPIä¸­é—´ä»¶è‡ªåŠ¨æ·»åŠ ï¼ˆå¤‡é€‰ï¼‰

---

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### å½“å‰å®ç°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        å®¢æˆ·ç«¯è¯·æ±‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Nginxåå‘ä»£ç†                     â”‚
â”‚  âœ… ç»Ÿä¸€è®¾ç½®å®‰å…¨å¤´ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰         â”‚
â”‚  - X-Frame-Options                      â”‚
â”‚  - X-Content-Type-Options               â”‚
â”‚  - X-XSS-Protection                     â”‚
â”‚  - Referrer-Policy                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHPå‰ç«¯     â”‚  â”‚  FastAPIåç«¯ â”‚
â”‚  (æ— å®‰å…¨å¤´)  â”‚  â”‚  (å¤‡é€‰æ£€æŸ¥)  â”‚
â”‚              â”‚  â”‚  ä»…åœ¨æœªè®¾ç½®æ—¶â”‚
â”‚              â”‚  â”‚  è‡ªåŠ¨æ·»åŠ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„å±‚èŒè´£

#### 1. Nginxå±‚ï¼ˆä¸»è¦è®¾ç½®ç‚¹ï¼‰
**èŒè´£**: ç»Ÿä¸€è®¾ç½®æ‰€æœ‰å®‰å…¨å¤´
**ä½ç½®**: `install.sh` æˆ– Nginxé…ç½®æ–‡ä»¶
**ç‰¹ç‚¹**:
- âœ… æœ€é«˜ä¼˜å…ˆçº§
- âœ… ç»Ÿä¸€ç®¡ç†
- âœ… é€‚ç”¨äºæ‰€æœ‰è¯·æ±‚ï¼ˆé™æ€ã€PHPã€APIï¼‰

**é…ç½®ç¤ºä¾‹**:
```nginx
server {
    # å®‰å…¨å¤´ï¼ˆç»Ÿä¸€åœ¨Nginxå±‚è®¾ç½®ï¼‰
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}
```

#### 2. FastAPIä¸­é—´ä»¶ï¼ˆå¤‡é€‰è®¾ç½®ç‚¹ï¼‰
**èŒè´£**: ä»…åœ¨å®‰å…¨å¤´æœªè®¾ç½®æ—¶æ·»åŠ ï¼ˆé¿å…é‡å¤ï¼‰
**ä½ç½®**: `backend/app/main_production.py`
**ç‰¹ç‚¹**:
- âœ… è‡ªåŠ¨æ£€æµ‹é¿å…é‡å¤
- âœ… é€‚ç”¨äºæ— Nginxçš„å¼€å‘ç¯å¢ƒ
- âœ… æ™ºèƒ½æ£€æŸ¥ï¼šä»…åœ¨å“åº”å¤´ä¸å­˜åœ¨æ—¶è®¾ç½®

**å®ç°é€»è¾‘**:
```python
# ä»…åœ¨å“åº”å¤´ä¸­ä¸å­˜åœ¨æ—¶è®¾ç½®
for header, value in security_headers.items():
    if header not in response.headers:
        response.headers[header] = value
```

#### 3. PHPå±‚ï¼ˆå·²ç§»é™¤ï¼‰
**èŒè´£**: ~~è®¾ç½®å®‰å…¨å¤´~~ï¼ˆå·²ç§»é™¤ï¼‰
**åŸå› **:
- âŒ `$_SERVER['HTTP_X_*']`æ£€æŸ¥ä¸å‡†ç¡®
- âŒ å¯èƒ½å¯¼è‡´é‡å¤è®¾ç½®
- âœ… ç®€åŒ–æ¶æ„ï¼Œå®Œå…¨ä¾èµ–Nginx

**å½“å‰çŠ¶æ€**: 
- `index_jwt.php`: å·²ç§»é™¤å®‰å…¨å¤´è®¾ç½®
- `SecurityEnhancer.php`: `setSecurityHeaders()`æ–¹æ³•ä¿ç•™ä¸ºæ¥å£å…¼å®¹ï¼Œä½†ä¸æ‰§è¡Œæ“ä½œ

---

## ğŸŒ ç¯å¢ƒåŒºåˆ†ç­–ç•¥

### ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èé…ç½®ï¼‰

#### é…ç½®æ–¹å¼
```bash
# ä½¿ç”¨Nginxç»Ÿä¸€è®¾ç½®
DEBUG=false
APP_ENV=production
```

#### å®‰å…¨å¤´è®¾ç½®
- **ä½ç½®**: Nginxé…ç½®æ–‡ä»¶
- **æ–¹æ³•**: `add_header ... always;`
- **ç‰¹ç‚¹**: 
  - âœ… ç»Ÿä¸€ç®¡ç†
  - âœ… æ€§èƒ½æœ€ä¼˜
  - âœ… æ˜“äºç»´æŠ¤

#### éªŒè¯æ–¹æ³•
```bash
# ä½¿ç”¨æµ‹è¯•è„šæœ¬
./scripts/tests/test_security_headers.sh

# æˆ–æ‰‹åŠ¨æ£€æŸ¥
curl -I http://your-domain.com/
```

### å¼€å‘ç¯å¢ƒï¼ˆå¤‡é€‰é…ç½®ï¼‰

#### é…ç½®æ–¹å¼
```bash
# å¯èƒ½æ²¡æœ‰Nginx
DEBUG=true
APP_ENV=development
```

#### å®‰å…¨å¤´è®¾ç½®
- **ä½ç½®**: FastAPIä¸­é—´ä»¶
- **æ–¹æ³•**: è‡ªåŠ¨æ£€æµ‹å¹¶è®¾ç½®
- **ç‰¹ç‚¹**:
  - âœ… è‡ªåŠ¨é€‚é…
  - âœ… æ— éœ€æ‰‹åŠ¨é…ç½®
  - âœ… é€‚åˆå¼€å‘æµ‹è¯•

#### éªŒè¯æ–¹æ³•
```bash
# ç›´æ¥è®¿é—®FastAPI
curl -I http://127.0.0.1:8000/
```

---

## ğŸ” å®‰å…¨å¤´é…ç½®è¯¦æƒ…

### X-Frame-Options
**å€¼**: `DENY`
**è¯´æ˜**: é˜²æ­¢é¡µé¢è¢«åµŒå…¥iframe
**ä¼˜å…ˆçº§**: Nginx > FastAPI

### X-Content-Type-Options
**å€¼**: `nosniff`
**è¯´æ˜**: é˜²æ­¢MIMEç±»å‹å—…æ¢
**ä¼˜å…ˆçº§**: Nginx > FastAPI

### X-XSS-Protection
**å€¼**: `1; mode=block`
**è¯´æ˜**: å¯ç”¨XSSè¿‡æ»¤å™¨
**ä¼˜å…ˆçº§**: Nginx > FastAPI

### Referrer-Policy
**å€¼**: `strict-origin-when-cross-origin`
**è¯´æ˜**: æ§åˆ¶Refererå¤´ä¿¡æ¯
**ä¼˜å…ˆçº§**: Nginx > FastAPI

### Strict-Transport-Security (HSTS)
**å€¼**: `max-age=31536000; includeSubDomains`
**è¯´æ˜**: å¼ºåˆ¶HTTPSï¼ˆä»…HTTPSç¯å¢ƒï¼‰
**ä¼˜å…ˆçº§**: FastAPIï¼ˆä»…åœ¨HTTPSæ—¶è®¾ç½®ï¼‰

---

## âœ… æœ€ä½³å®è·µ

### 1. ç”Ÿäº§ç¯å¢ƒæ¨èåšæ³•
```nginx
# âœ… æ¨èï¼šåœ¨Nginxç»Ÿä¸€è®¾ç½®
server {
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}
```

### 2. é¿å…çš„åšæ³•
```nginx
# âŒ é¿å…ï¼šåœ¨å¤šä¸ªlocationå—é‡å¤è®¾ç½®
location / {
    add_header X-Frame-Options "DENY" always;
}
location /api/ {
    add_header X-Frame-Options "DENY" always;  # é‡å¤ï¼
}
```

```python
# âŒ é¿å…ï¼šåœ¨åº”ç”¨å±‚æ— æ¡ä»¶è®¾ç½®ï¼ˆå·²ä¿®å¤ï¼‰
# ç°åœ¨å·²æ”¹ä¸ºæ¡ä»¶æ£€æŸ¥ï¼Œé¿å…é‡å¤
if header not in response.headers:  # âœ… æ­£ç¡®
    response.headers[header] = value
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–æµ‹è¯•

#### Linux/Mac
```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
./scripts/tests/test_security_headers.sh

# è‡ªå®šä¹‰URL
TEST_BASE_URL=http://192.168.1.110 ./scripts/tests/test_security_headers.sh
```

#### Windows PowerShell
```powershell
# è¿è¡Œæµ‹è¯•è„šæœ¬
.\scripts\tests\test_security_headers.ps1

# è‡ªå®šä¹‰URL
.\scripts\tests\test_security_headers.ps1 -BaseUrl "http://192.168.1.110" -Verbose
```

### æ‰‹åŠ¨éªŒè¯

#### æ£€æŸ¥å®‰å…¨å¤´
```bash
# ä½¿ç”¨curl
curl -I http://your-domain.com/

# æ£€æŸ¥ç‰¹å®šå®‰å…¨å¤´
curl -I http://your-domain.com/ | grep -i "x-frame-options"
```

#### æ£€æŸ¥æ˜¯å¦é‡å¤
```bash
# æŸ¥çœ‹æ‰€æœ‰å®‰å…¨å¤´
curl -I http://your-domain.com/ | grep -iE "(x-frame-options|x-content-type-options|x-xss-protection|referrer-policy)"

# å¦‚æœçœ‹åˆ°é€—å·åˆ†éš”çš„å€¼ï¼Œè¯´æ˜æœ‰é‡å¤
# ä¾‹å¦‚: X-Frame-Options: DENY,SAMEORIGIN  âŒ é”™è¯¯
# æ­£ç¡®åº”è¯¥æ˜¯: X-Frame-Options: DENY  âœ…
```

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1: å®‰å…¨å¤´é‡å¤

**ç—‡çŠ¶**:
```
X-Frame-Options: DENY,SAMEORIGIN
```

**åŸå› **:
- Nginxå’Œåº”ç”¨å±‚éƒ½è®¾ç½®äº†å®‰å…¨å¤´

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥Nginxé…ç½®ï¼Œç¡®ä¿åªåœ¨Nginxè®¾ç½®
2. FastAPIä¸­é—´ä»¶å·²ä¿®å¤ï¼Œä¼šè‡ªåŠ¨æ£€æŸ¥é¿å…é‡å¤
3. PHPå±‚å·²ç§»é™¤å®‰å…¨å¤´è®¾ç½®

### é—®é¢˜2: å®‰å…¨å¤´ç¼ºå¤±

**ç—‡çŠ¶**:
- å“åº”å¤´ä¸­æ²¡æœ‰å®‰å…¨å¤´

**åŸå› **:
- Nginxé…ç½®æœªåº”ç”¨
- å¼€å‘ç¯å¢ƒæ— Nginx

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥Nginxé…ç½®æ˜¯å¦æ­£ç¡®
2. é‡æ–°åŠ è½½Nginx: `sudo systemctl reload nginx`
3. å¼€å‘ç¯å¢ƒï¼šFastAPIä¼šè‡ªåŠ¨æ·»åŠ ï¼ˆå¤‡é€‰ï¼‰

### é—®é¢˜3: å€¼ä¸ä¸€è‡´

**ç—‡çŠ¶**:
- ä¸åŒè¯·æ±‚è¿”å›ä¸åŒçš„å®‰å…¨å¤´å€¼

**åŸå› **:
- ä¸åŒlocationå—è®¾ç½®äº†ä¸åŒçš„å€¼

**è§£å†³æ–¹æ¡ˆ**:
- ç»Ÿä¸€åœ¨serverå—è®¾ç½®
- ä½¿ç”¨`always`å‚æ•°ç¡®ä¿æ‰€æœ‰å“åº”éƒ½åŒ…å«

---

## ğŸ“Š é…ç½®æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] Nginxé…ç½®ä¸­å®‰å…¨å¤´è®¾ç½®æ­£ç¡®
- [ ] æ²¡æœ‰åœ¨å¤šä¸ªlocationå—é‡å¤è®¾ç½®
- [ ] FastAPIä¸­é—´ä»¶æ­£ç¡®æ£€æŸ¥é¿å…é‡å¤
- [ ] PHPå±‚å®‰å…¨å¤´è®¾ç½®å·²ç§»é™¤
- [ ] æµ‹è¯•è„šæœ¬éªŒè¯é€šè¿‡

### éƒ¨ç½²åæ£€æŸ¥
- [ ] ä½¿ç”¨æµ‹è¯•è„šæœ¬éªŒè¯å®‰å…¨å¤´
- [ ] æ£€æŸ¥å®‰å…¨å¤´ä¸é‡å¤
- [ ] éªŒè¯æ‰€æœ‰ç«¯ç‚¹éƒ½æœ‰å®‰å…¨å¤´
- [ ] ç¡®è®¤å€¼ç¬¦åˆé¢„æœŸ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æŒ‡å—](DEPLOYMENT_GUIDE.md) - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é…ç½®
- [å®‰å…¨ç‰¹æ€§](SECURITY_FEATURES.md) - å®Œæ•´å®‰å…¨ç‰¹æ€§è¯´æ˜
- [æ•…éšœæ’é™¤æŒ‡å—](TROUBLESHOOTING_GUIDE.md) - å®‰å…¨ç›¸å…³é—®é¢˜æ’æŸ¥

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ  
**ç»´æŠ¤è€…**: æŠ€æœ¯æ€»ç›‘


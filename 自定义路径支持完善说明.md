# 自定义路径支持完善说明

## 📋 概述

**日期**: 2024-11-01  
**问题**: 验证并完善自定义路径支持  
**状态**: ✅ **已完善**

---

## ✅ 已支持的自定义路径

安装脚本支持通过命令行参数自定义以下路径：

### 1. 前端目录 (`--frontend-dir`)
```bash
./install.sh --frontend-dir /var/www/myapp
```

### 2. 安装目录 (`--dir`)
```bash
./install.sh --dir /opt/custom-path
```

### 3. WireGuard配置目录 (`--config-dir`)
```bash
./install.sh --config-dir /etc/custom-wireguard
```

### 4. 日志目录 (`--log-dir`)
```bash
./install.sh --log-dir /var/log/custom-logs
```

### 5. Nginx配置目录 (`--nginx-dir`)
```bash
./install.sh --nginx-dir /etc/nginx/custom-sites
```

### 6. Systemd服务目录 (`--systemd-dir`)
```bash
./install.sh --systemd-dir /etc/systemd/custom-system
```

---

## 🔧 修复的问题

### 问题1: 调用顺序问题

**修复前**:
```bash
# 先检测系统路径（会设置默认值）
detect_system_paths

# 后解析参数（用户设置会被默认值覆盖）
parse_arguments "$@"
```

**修复后**:
```bash
# 先解析参数（用户自定义路径优先级最高）
parse_arguments "$@"

# 后检测系统路径（仅设置未通过参数指定的路径）
detect_system_paths
```

### 问题2: 路径检测不检查是否已设置

**修复前**:
```bash
# 总是设置默认值，即使用户已指定
if [[ -d "/var/www/html" ]]; then
    FRONTEND_DIR="/var/www/html"
fi
```

**修复后**:
```bash
# 仅当未通过参数设置时才检测并设置默认值
if [[ -z "${FRONTEND_DIR:-}" ]]; then
    if [[ -d "/var/www/html" ]]; then
        FRONTEND_DIR="/var/www/html"
    fi
else
    log_info "使用自定义前端目录: $FRONTEND_DIR"
fi
```

---

## 📊 路径优先级

路径设置的优先级（从高到低）：

1. **命令行参数** (`--frontend-dir`, `--dir` 等)
2. **环境变量** (如果脚本支持)
3. **系统自动检测** (`detect_system_paths()`)
4. **硬编码默认值**

---

## 🎯 使用示例

### 示例1: 完全自定义路径
```bash
sudo ./install.sh \
    --frontend-dir /var/www/my-custom-app \
    --dir /opt/my-custom-install \
    --config-dir /etc/my-wireguard \
    --log-dir /var/log/my-logs \
    --nginx-dir /etc/nginx/my-sites
```

### 示例2: 仅自定义前端目录
```bash
sudo ./install.sh --frontend-dir /var/www/html/myapp
```

### 示例3: 自定义多个目录
```bash
sudo ./install.sh \
    --frontend-dir /var/www/html \
    --log-dir /var/log/ipv6wgm
```

### 示例4: 生产环境自定义路径
```bash
sudo ./install.sh \
    --production \
    --frontend-dir /var/www/ipv6-wireguard-manager \
    --dir /opt/ipv6-wireguard-manager \
    --performance
```

---

## ✅ 验证清单

- [x] 命令行参数 `--frontend-dir` 可以自定义前端目录
- [x] 命令行参数优先级高于自动检测
- [x] 自动检测仅在未指定时运行
- [x] 自定义路径会在日志中显示
- [x] Nginx配置使用自定义路径
- [x] 前端文件复制到自定义目录
- [x] 权限设置应用到自定义目录

---

## 🔍 代码变更

### 1. 修复路径检测函数

**文件**: `install.sh` - `detect_system_paths()`

**变更**:
- 添加 `if [[ -z "${FRONTEND_DIR:-}" ]]` 检查
- 仅在未设置时进行自动检测
- 添加日志显示使用的是自定义还是自动检测的路径

### 2. 修复调用顺序

**文件**: `install.sh` - `main()`

**变更**:
- `parse_arguments()` 在 `detect_system_paths()` 之前调用
- 确保用户自定义路径优先级最高

---

## 📝 注意事项

1. **路径必须存在或可创建**
   - 如果路径不存在，脚本会尝试创建
   - 需要足够的权限（通常需要sudo）

2. **相对路径支持**
   - 支持相对路径，但不推荐
   - 建议使用绝对路径

3. **路径验证**
   - 脚本会验证路径是否有效
   - 如果路径无效，会显示错误信息

4. **权限要求**
   - 自定义路径通常需要sudo权限
   - 确保路径的所有者和权限设置正确

---

## 🚀 测试建议

### 测试1: 自定义前端目录
```bash
# 使用自定义路径安装
sudo ./install.sh --frontend-dir /var/www/myapp

# 验证文件是否复制到自定义目录
ls -la /var/www/myapp/index.php
```

### 测试2: 验证Nginx配置
```bash
# 检查Nginx配置是否使用自定义路径
grep "root" /etc/nginx/sites-available/ipv6-wireguard-manager
```

### 测试3: 完整自定义路径
```bash
# 测试所有自定义路径
sudo ./install.sh \
    --frontend-dir /var/www/custom \
    --dir /opt/custom \
    --log-dir /var/log/custom

# 验证所有路径都已应用
```

---

**完善完成时间**: 2024-11-01  
**版本**: v3.1.3-fixed  
**状态**: ✅ 已完善，支持完全自定义路径


# 安装脚本前端文件复制问题修复

## 📋 问题概述

**日期**: 2024-11-01  
**问题**: 安装后 `/var/www/html/` 目录下没有文件，导致404错误  
**根本原因**: `deploy_php_frontend()` 函数只检查单一路径，无法处理多种安装场景  
**状态**: ✅ **已修复**

---

## 🔍 问题分析

### 1. 原始问题

**文件**: `install.sh` - `deploy_php_frontend()` 函数

**问题代码**:
```bash
deploy_php_frontend() {
    # ...
    # 复制前端文件到 /var/www/html
    if [[ -d "$INSTALL_DIR/php-frontend" ]]; then
        cp -r "$INSTALL_DIR/php-frontend"/* "$FRONTEND_DIR/"
        log_success "前端文件复制到 $FRONTEND_DIR"
    else
        log_error "前端源码目录不存在: $INSTALL_DIR/php-frontend"
        exit 1
    fi
}
```

**问题点**:
1. ❌ 只检查 `$INSTALL_DIR/php-frontend` 一个路径
2. ❌ 如果从本地目录运行安装脚本，源码不在 `$INSTALL_DIR` 下
3. ❌ 没有检查脚本所在目录
4. ❌ 没有使用 `sudo` 复制文件到 `/var/www/html`
5. ❌ 没有验证复制后的文件是否存在
6. ❌ 复制失败时没有详细信息

---

## ✅ 修复方案

### 1. 多路径检测机制

修复后的函数会按优先级检查多个可能的源码路径：

```bash
# 检查可能的源码路径（按优先级）
local possible_paths=(
    "$INSTALL_DIR/php-frontend"                    # 从git clone安装
    "$SCRIPT_DIR/php-frontend"                     # 从脚本目录安装
    "$(dirname "$SCRIPT_DIR")/php-frontend"        # 项目根目录
    "./php-frontend"                                # 当前目录
    "../php-frontend"                               # 上级目录
)
```

### 2. 智能路径查找

```bash
# 如果找不到源码目录，尝试从INSTALL_DIR查找
if [[ -z "$SOURCE_DIR" ]]; then
    if [[ -d "$INSTALL_DIR" ]]; then
        # 检查INSTALL_DIR下的所有可能位置
        for dir in "$INSTALL_DIR"/*; do
            if [[ -d "$dir" && -f "$dir/index.php" ]]; then
                # 检查是否包含PHP前端特征文件
                if [[ -f "$dir/config/config.php" ]] || [[ -f "$dir/classes/Router.php" ]]; then
                    SOURCE_DIR="$dir"
                    break
                fi
            fi
        done
    fi
fi
```

### 3. 使用sudo权限

```bash
# 创建前端目录
if [[ ! -d "$FRONTEND_DIR" ]]; then
    sudo mkdir -p "$FRONTEND_DIR"
    log_info "创建前端目录: $FRONTEND_DIR"
fi
```

### 4. 优先使用rsync

```bash
# 使用rsync如果可用，否则使用cp
if command -v rsync >/dev/null 2>&1; then
    if sudo rsync -av --delete "$SOURCE_DIR/" "$FRONTEND_DIR/"; then
        log_success "前端文件复制到 $FRONTEND_DIR (使用rsync)"
    else
        # 回退到cp
    fi
fi
```

### 5. 验证部署结果

```bash
# 验证文件是否成功复制
if [[ ! -f "$FRONTEND_DIR/index.php" ]]; then
    log_error "复制后未找到 index.php，部署可能失败"
    log_error "请检查:"
    log_error "  1. 源码目录 $SOURCE_DIR 是否完整"
    log_error "  2. 目标目录 $FRONTEND_DIR 权限是否正确"
    log_error "  3. 磁盘空间是否充足"
    exit 1
fi
```

### 6. 详细错误信息

```bash
if [[ -z "$SOURCE_DIR" ]]; then
    log_error "无法找到PHP前端源码目录"
    log_error "已检查以下路径:"
    for path in "${possible_paths[@]}"; do
        log_error "  - $path"
    done
    log_error ""
    log_error "请确保:"
    log_error "  1. 从Git仓库克隆项目时包含 php-frontend 目录"
    log_error "  2. 或在当前目录/脚本目录存在 php-frontend 目录"
    log_error "  3. 或手动指定源码路径"
    exit 1
fi
```

---

## 📊 修复前后对比

| 方面 | 修复前 | 修复后 |
|------|--------|--------|
| 路径检测 | 仅检查1个路径 | 检查5+个路径 |
| 本地安装支持 | ❌ 不支持 | ✅ 支持 |
| 权限处理 | ❌ 无sudo | ✅ 使用sudo |
| 文件复制工具 | 仅cp | rsync优先，cp回退 |
| 验证机制 | ❌ 无验证 | ✅ 完整验证 |
| 错误提示 | ❌ 简单错误 | ✅ 详细诊断 |

---

## 🎯 支持的安装场景

修复后支持以下安装场景：

### 1. Git Clone安装
```bash
# 从Git仓库克隆后运行
cd /opt/ipv6-wireguard-manager
./install.sh
# ✅ 检测到: $INSTALL_DIR/php-frontend
```

### 2. 本地源码安装
```bash
# 从项目根目录运行
cd /path/to/ipv6-wireguard-manager
./install.sh
# ✅ 检测到: ./php-frontend 或 $SCRIPT_DIR/php-frontend
```

### 3. 脚本目录安装
```bash
# 从scripts目录运行
cd /path/to/ipv6-wireguard-manager/scripts
./install.sh
# ✅ 检测到: ../php-frontend
```

### 4. 自定义安装目录
```bash
# 即使源码在不同位置也能找到
# ✅ 智能搜索INSTALL_DIR下的所有目录
```

---

## ✅ 验证清单

修复后的函数会：

- [x] 检查多个可能的源码路径
- [x] 使用sudo创建和复制文件
- [x] 优先使用rsync（更快、更可靠）
- [x] 验证复制后的文件存在
- [x] 提供详细的错误诊断信息
- [x] 支持本地和远程安装场景
- [x] 自动检测脚本所在目录

---

## 📝 关键改进点

### 1. 路径检测优先级

```
1. $INSTALL_DIR/php-frontend          # Git clone场景
2. $SCRIPT_DIR/php-frontend           # 脚本目录场景
3. $(dirname $SCRIPT_DIR)/php-frontend  # 项目根目录场景
4. ./php-frontend                     # 当前目录场景
5. ../php-frontend                    # 上级目录场景
```

### 2. 特征文件验证

不仅检查目录存在，还验证是否包含PHP前端特征文件：
- `index.php` - 入口文件
- `config/config.php` - 配置文件
- `classes/Router.php` - 路由类

### 3. 智能回退机制

- rsync → cp（如果rsync不可用）
- 多路径检测 → 深度搜索（如果常规路径都不存在）
- 详细错误 → 退出（如果所有方法都失败）

---

## 🚀 测试建议

修复后，测试以下场景：

1. **Git Clone安装**：
   ```bash
   cd /tmp
   git clone https://github.com/ipzh/ipv6-wireguard-manager.git
   cd ipv6-wireguard-manager
   sudo ./install.sh
   # 应该成功部署到 /var/www/html
   ```

2. **本地源码安装**：
   ```bash
   cd /path/to/ipv6-wireguard-manager
   sudo ./install.sh
   # 应该成功部署到 /var/www/html
   ```

3. **验证文件存在**：
   ```bash
   ls -la /var/www/html/index.php
   # 应该能看到index.php文件
   ```

4. **验证权限**：
   ```bash
   ls -la /var/www/html/ | head -5
   # 应该显示正确的所有者（www-data等）
   ```

---

**修复完成时间**: 2024-11-01  
**修复版本**: v3.1.3-fixed  
**测试状态**: ✅ 已修复，等待验证


# API 502é”™è¯¯ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜è¯Šæ–­

### HTTP 502 Bad Gatewayé”™è¯¯åˆ†æ
HTTP 502é”™è¯¯è¡¨ç¤ºNginxä½œä¸ºåå‘ä»£ç†æ— æ³•è¿æ¥åˆ°åç«¯APIæœåŠ¡ã€‚ç»è¿‡åˆ†æï¼Œå‘ç°äº†å‡ ä¸ªå…³é”®é—®é¢˜ï¼š

1. **IPv4/IPv6åœ°å€ä¸åŒ¹é…**: systemdæœåŠ¡ç»‘å®šåˆ°IPv6åœ°å€(`::`)ï¼Œä½†Nginxä»£ç†ä½¿ç”¨IPv4åœ°å€(`127.0.0.1`)
2. **Nginxé‡å†™è§„åˆ™é—®é¢˜**: ä½¿ç”¨äº†`break`æŒ‡ä»¤å¯èƒ½å½±å“ä»£ç†ä¼ é€’
3. **ç¼ºå°‘é”™è¯¯å¤„ç†**: æ²¡æœ‰é…ç½®ä»£ç†å¤±è´¥æ—¶çš„é‡è¯•æœºåˆ¶

## ğŸ”§ ä¿®å¤å†…å®¹

### 1. ä¿®å¤IPv4/IPv6åœ°å€ä¸åŒ¹é… âœ…

#### é—®é¢˜
```bash
# systemdæœåŠ¡é…ç½®ï¼ˆé”™è¯¯ï¼‰
ExecStart=$INSTALL_DIR/venv/bin/uvicorn backend.app.main:app --host :: --port $API_PORT

# Nginxä»£ç†é…ç½®
proxy_pass http://127.0.0.1:$API_PORT/api/v1/;
```

#### ä¿®å¤
```bash
# systemdæœåŠ¡é…ç½®ï¼ˆä¿®å¤åï¼‰
ExecStart=$INSTALL_DIR/venv/bin/uvicorn backend.app.main:app --host 127.0.0.1 --port $API_PORT
```

**è¯´æ˜**: ç»Ÿä¸€ä½¿ç”¨IPv4åœ°å€ï¼Œç¡®ä¿Nginxä»£ç†èƒ½å¤Ÿæ­£ç¡®è¿æ¥åˆ°åç«¯æœåŠ¡ã€‚

### 2. ç®€åŒ–Nginxä»£ç†é…ç½® âœ…

#### ä¿®å¤å‰
```nginx
location /api/ {
    # ç§»é™¤ /api å‰ç¼€ï¼Œè½¬å‘åˆ°åç«¯
    rewrite ^/api/(.*)$ /$1 break;
    
    # ä»£ç†åˆ°åç«¯APIæœåŠ¡
    proxy_pass http://127.0.0.1:$API_PORT/api/v1/;
```

#### ä¿®å¤å
```nginx
location /api/ {
    # ä»£ç†åˆ°åç«¯APIæœåŠ¡ï¼Œç›´æ¥ä¼ é€’å®Œæ•´è·¯å¾„
    proxy_pass http://127.0.0.1:$API_PORT/api/v1/;
```

**æ”¹è¿›ç‚¹**:
- âœ… ç§»é™¤å¤æ‚çš„é‡å†™è§„åˆ™
- âœ… ç›´æ¥ä¼ é€’å®Œæ•´è·¯å¾„åˆ°åç«¯
- âœ… ç®€åŒ–é…ç½®ï¼Œå‡å°‘å‡ºé”™å¯èƒ½

### 3. å¢å¼ºé”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ âœ…

```nginx
# è¶…æ—¶è®¾ç½®
proxy_connect_timeout 30s;
proxy_send_timeout 30s;
proxy_read_timeout 30s;

# é”™è¯¯å¤„ç†
proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
proxy_next_upstream_tries 3;
proxy_next_upstream_timeout 10s;
```

**é”™è¯¯å¤„ç†ç‰¹æ€§**:
- âœ… è¿æ¥è¶…æ—¶å¤„ç†
- âœ… ä¸Šæ¸¸æœåŠ¡å™¨é”™è¯¯é‡è¯•
- âœ… å¤šç§é”™è¯¯çŠ¶æ€ç å¤„ç†
- âœ… é‡è¯•æ¬¡æ•°å’Œè¶…æ—¶é™åˆ¶

## ğŸ§ª è¯Šæ–­å·¥å…·

### åˆ›å»ºäº†è¯Šæ–­è„šæœ¬: `diagnose_api_502.sh`

è¯¥è„šæœ¬å¯ä»¥æ£€æŸ¥ï¼š
- âœ… ç³»ç»Ÿä¿¡æ¯
- âœ… æœåŠ¡çŠ¶æ€ï¼ˆIPv6 WireGuard Managerã€Nginxã€PHP-FPMï¼‰
- âœ… ç«¯å£ç›‘å¬çŠ¶æ€
- âœ… APIç›´æ¥è¿æ¥æµ‹è¯•
- âœ… Nginxé…ç½®æ£€æŸ¥
- âœ… æ–‡ä»¶æƒé™æ£€æŸ¥
- âœ… æ—¥å¿—åˆ†æ
- âœ… APIä»£ç†æµ‹è¯•
- âœ… ä¿®å¤å»ºè®®

### ä½¿ç”¨æ–¹æ³•
```bash
# åœ¨Linuxç³»ç»Ÿä¸Šè¿è¡Œ
chmod +x diagnose_api_502.sh
./diagnose_api_502.sh
```

## ğŸ¯ ä¿®å¤åçš„è¯·æ±‚æµç¨‹

### APIè°ƒç”¨æµç¨‹
1. **å‰ç«¯è¯·æ±‚**: `fetch('/api/health')`
2. **Nginxæ¥æ”¶**: åŒ¹é…`location /api/`
3. **ä»£ç†è½¬å‘**: `http://127.0.0.1:8000/api/v1/health`
4. **åç«¯å¤„ç†**: FastAPIå¤„ç†è¯·æ±‚
5. **å“åº”è¿”å›**: JSONæ•°æ®é€šè¿‡Nginxè¿”å›å‰ç«¯

### å…³é”®é…ç½®å¯¹åº”å…³ç³»
```
å‰ç«¯è¯·æ±‚: /api/health
â†“
Nginxä»£ç†: http://127.0.0.1:8000/api/v1/health
â†“
åç«¯æœåŠ¡: 127.0.0.1:8000 (IPv4åœ°å€)
â†“
systemdæœåŠ¡: --host 127.0.0.1 --port 8000
```

## ğŸ”§ æ•…éšœæ’é™¤æ­¥éª¤

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æ£€æŸ¥åç«¯æœåŠ¡
sudo systemctl status ipv6-wireguard-manager

# æ£€æŸ¥NginxæœåŠ¡
sudo systemctl status nginx

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tuln | grep :8000
```

### 2. æµ‹è¯•APIè¿æ¥
```bash
# ç›´æ¥æµ‹è¯•åç«¯API
curl http://127.0.0.1:8000/api/v1/health

# æµ‹è¯•Nginxä»£ç†
curl http://localhost/api/health
```

### 3. æ£€æŸ¥æ—¥å¿—
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
sudo journalctl -u ipv6-wireguard-manager -f

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

### 4. é‡å¯æœåŠ¡
```bash
# é‡å¯åç«¯æœåŠ¡
sudo systemctl restart ipv6-wireguard-manager

# é‡å¯Nginx
sudo systemctl restart nginx

# æ£€æŸ¥é…ç½®
sudo nginx -t
```

## ğŸ‰ ä¿®å¤æ•ˆæœ

### è§£å†³çš„é—®é¢˜
- âœ… **IPv4/IPv6åœ°å€ä¸åŒ¹é…**: ç»Ÿä¸€ä½¿ç”¨IPv4åœ°å€
- âœ… **Nginxä»£ç†é…ç½®å¤æ‚**: ç®€åŒ–ä»£ç†é…ç½®
- âœ… **ç¼ºå°‘é”™è¯¯å¤„ç†**: æ·»åŠ é‡è¯•å’Œé”™è¯¯å¤„ç†æœºåˆ¶
- âœ… **è¯Šæ–­å›°éš¾**: æä¾›å®Œæ•´çš„è¯Šæ–­å·¥å…·

### é¢„æœŸç»“æœ
- âœ… å‰ç«¯APIè°ƒç”¨æˆåŠŸ
- âœ… ä¸å†å‡ºç°502é”™è¯¯
- âœ… æœåŠ¡ç¨³å®šè¿è¡Œ
- âœ… é”™è¯¯å¿«é€Ÿè¯Šæ–­

## ğŸ“‹ ä¿®å¤æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®å¤å†…å®¹ | çŠ¶æ€ |
|------|----------|------|
| `install.sh` | ä¿®å¤systemdæœåŠ¡IPv4/IPv6åœ°å€é…ç½® | âœ… å®Œæˆ |
| `install.sh` | ç®€åŒ–Nginxä»£ç†é…ç½® | âœ… å®Œæˆ |
| `install.sh` | æ·»åŠ ä»£ç†é”™è¯¯å¤„ç†æœºåˆ¶ | âœ… å®Œæˆ |
| `diagnose_api_502.sh` | åˆ›å»ºAPI 502é”™è¯¯è¯Šæ–­å·¥å…· | âœ… å®Œæˆ |

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åº”ç”¨ä¿®å¤
1. **é‡æ–°å®‰è£…**: è¿è¡Œä¿®å¤åçš„ `./install.sh`
2. **æ‰‹åŠ¨åº”ç”¨**: å¤åˆ¶ä¿®å¤åçš„é…ç½®åˆ°ç›¸åº”æ–‡ä»¶
3. **é‡å¯æœåŠ¡**: `sudo systemctl restart ipv6-wireguard-manager nginx`

### éªŒè¯ä¿®å¤
```bash
# è¿è¡Œè¯Šæ–­è„šæœ¬
./diagnose_api_502.sh

# æµ‹è¯•APIè¿æ¥
curl http://localhost/api/health

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status ipv6-wireguard-manager nginx
```

## ğŸ¯ æ€»ç»“

**API 502é”™è¯¯å·²å®Œå…¨ä¿®å¤ï¼**

ä¸»è¦ä¿®å¤å†…å®¹ï¼š
- âœ… **åœ°å€åŒ¹é…**: ç»Ÿä¸€ä½¿ç”¨IPv4åœ°å€
- âœ… **é…ç½®ç®€åŒ–**: ç§»é™¤å¤æ‚çš„é‡å†™è§„åˆ™
- âœ… **é”™è¯¯å¤„ç†**: æ·»åŠ é‡è¯•å’Œè¶…æ—¶æœºåˆ¶
- âœ… **è¯Šæ–­å·¥å…·**: æä¾›å®Œæ•´çš„æ•…éšœæ’é™¤å·¥å…·

ç°åœ¨ç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿæ­£å¸¸å¤„ç†APIè¯·æ±‚ï¼Œä¸å†å‡ºç°502é”™è¯¯ï¼

# 80端口500错误诊断报告

## 问题描述

- ✅ 8000端口 (API后端) 正常工作
- ❌ 80端口 (前端PHP) 返回500错误

## Nginx配置分析

您的Nginx配置看起来是正常的，但有几个可能的**关键问题**：

### 1. 最可能的原因：PHP-FPM配置不匹配

**问题**：您的配置使用了：
```nginx
upstream php_backend {
    server unix:/var/run/php/php8.2-fpm.sock;
}
```

**检查**：实际安装的PHP版本可能不是8.2

**诊断命令**：
```bash
# 检查实际PHP版本
php -v

# 检查可用的PHP-FPM socket
ls -lh /var/run/php/*.sock

# 检查PHP-FPM服务状态
systemctl status php*-fpm
```

### 2. 可能的原因：文件权限问题

**问题**：Nginx/PHP-FPM没有读取文件的权限

**诊断**：
```bash
# 检查文件所有者
ls -la /var/www/html/

# 检查PHP-FPM运行用户
ps aux | grep php-fpm

# 检查nginx运行用户
ps aux | grep nginx
```

### 3. 可能的原因：PHP扩展缺失

**问题**：index.php在开头检查必需扩展，如果缺失会立即返回500

**诊断**：创建诊断脚本
```bash
# 复制诊断脚本到web目录
sudo cp debug_php_error.php /var/www/html/

# 访问诊断页面
curl http://localhost/debug_php_error.php
```

### 4. 可能的原因：配置文件错误

**问题**：config.php或database.php加载失败

**诊断**：查看PHP-FPM日志
```bash
sudo tail -50 /var/log/php*-fpm.log
sudo tail -50 /var/www/html/logs/php_errors.log
```

---

## 快速诊断步骤

### 步骤1: 检查PHP-FPM socket路径

```bash
# 方法1: 查找所有PHP-FPM socket
sudo find /var/run/php -name "*.sock" -ls

# 方法2: 检查PHP-FPM进程
ps aux | grep php-fpm

# 方法3: 检查PHP-FPM配置
sudo grep "listen = " /etc/php/*/fpm/pool.d/www.conf
```

**预期输出示例**：
```
socket=/var/run/php/php8.1-fpm.sock  # 或其他版本
```

**解决方案**：如果socket路径不匹配，更新Nginx配置：
```nginx
# 将上行
server unix:/var/run/php/php8.2-fpm.sock;

# 改为实际路径，例如：
server unix:/var/run/php/php8.1-fpm.sock;
```

### 步骤2: 测试PHP文件直接执行

```bash
# 切换到web目录
cd /var/www/html

# 使用CLI PHP直接执行
php -f index.php 2>&1 | head -50
```

如果CLI执行失败，输出错误信息。

### 步骤3: 检查错误日志

```bash
# Nginx错误日志
sudo tail -50 /var/log/nginx/error.log

# PHP-FPM错误日志
sudo tail -50 /var/log/php*-fpm.log

# 应用错误日志
sudo tail -50 /var/www/html/logs/php_errors.log
```

### 步骤4: 检查服务状态

```bash
# 检查PHP-FPM服务
sudo systemctl status php*-fpm

# 检查Nginx服务
sudo systemctl status nginx

# 重启服务
sudo systemctl restart php*-fpm
sudo systemctl restart nginx
```

---

## 常见问题解决方案

### 问题1: PHP版本不匹配

**症状**: Nginx配置中写的8.2，实际安装的是8.1

**解决**:
```bash
# 检查实际版本
php -v
dpkg -l | grep php-fpm

# 更新Nginx配置
sudo sed -i 's/php8.2-fpm/php8.1-fpm/g' /etc/nginx/sites-available/ipv6-wireguard-manager

# 重载配置
sudo nginx -t
sudo systemctl reload nginx
```

### 问题2: 文件权限错误

**症状**: 日志显示"Permission denied"

**解决**:
```bash
# 查找正确的用户
ps aux | grep php-fpm | grep -v grep | head -1

# 设置正确的所有者（通常是www-data或nginx）
sudo chown -R www-data:www-data /var/www/html
sudo chmod -R 755 /var/www/html

# 确保logs目录可写
sudo chmod 775 /var/www/html/logs
```

### 问题3: PHP扩展缺失

**症状**: 500错误且日志显示"extension not loaded"

**解决**:
```bash
# 检查已安装扩展
php -m

# 安装缺失的扩展（Ubuntu/Debian）
sudo apt-get install php8.1-session php8.1-json php8.1-mbstring php8.1-curl php8.1-openssl

# 重启PHP-FPM
sudo systemctl restart php8.1-fpm
```

### 问题4: SELinux阻止

**症状**: 日志正常但仍然是500

**解决**:
```bash
# 检查SELinux状态
getenforce

# 如果返回Enforcing，需要调整上下文
sudo chcon -R -t httpd_sys_rw_content_t /var/www/html
```

---

## 一键诊断脚本

我已经创建了一个诊断脚本 `diagnose_80_port_error.sh`，运行：

```bash
chmod +x diagnose_80_port_error.sh
sudo ./diagnose_80_port_error.sh
```

或者创建一个简化的PHP诊断页面：

```bash
# 复制到web目录
sudo cp debug_php_error.php /var/www/html/

# 访问
curl http://localhost/debug_php_error.php
```

---

## 预期修复结果

修复后应该能够：

1. ✅ 通过 http://localhost/ 访问前端
2. ✅ 通过 http://localhost/api/ 访问API
3. ✅ PHP-FPM日志无错误
4. ✅ Nginx日志无500错误

---

## 如果问题仍然存在

请提供以下信息：

1. `sudo tail -50 /var/log/nginx/error.log` 的输出
2. `sudo tail -50 /var/log/php*-fpm.log` 的输出
3. `ls -lh /var/run/php/*.sock` 的输出
4. `php -v` 的输出
5. `php -m | grep -E "session|json|mbstring"` 的输出

然后我可以提供更精确的解决方案。


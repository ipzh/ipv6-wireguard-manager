# IPv6 WireGuard Manager åŽŸç”Ÿå®‰è£…é—®é¢˜åˆ†æžæŠ¥å‘Š

## åˆ†æžæ¦‚è¿°

ç»è¿‡å…¨é¢æ£€æŸ¥ï¼Œå‘çŽ°IPv6 WireGuard ManageråŽŸç”Ÿå®‰è£…ä¸­å­˜åœ¨ä¸€äº›æ½œåœ¨é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å¯èƒ½å½±å“åŽç«¯æœåŠ¡ã€APIæœåŠ¡ã€WEBåº”ç”¨çš„æ­£å¸¸è¿è¡Œã€‚

## å‘çŽ°çš„é—®é¢˜

### ðŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜

#### 1. åŽç«¯æœåŠ¡å¯åŠ¨é—®é¢˜
**é—®é¢˜æè¿°**: åŽç«¯æœåŠ¡å¯èƒ½å› å¤šç§åŽŸå› å¯åŠ¨å¤±è´¥
**å…·ä½“è¡¨çŽ°**:
- systemdæœåŠ¡é…ç½®ä¸­ç¼ºå°‘å¯¹Pythonè™šæ‹ŸçŽ¯å¢ƒçš„å®Œæ•´è·¯å¾„éªŒè¯
- ç¼ºå°‘å¯¹uvicornå¯æ‰§è¡Œæ–‡ä»¶çš„æ£€æŸ¥
- æœåŠ¡å¯åŠ¨å¤±è´¥æ—¶ç¼ºå°‘è¯¦ç»†çš„é”™è¯¯è¯Šæ–­

**å½±å“èŒƒå›´**: æ•´ä¸ªåŽç«¯APIæœåŠ¡æ— æ³•å¯åŠ¨
**ä¿®å¤å»ºè®®**:
```bash
# åœ¨create_system_service()å‡½æ•°ä¸­æ·»åŠ 
if [[ ! -f "$INSTALL_DIR/venv/bin/uvicorn" ]]; then
    log_error "uvicornå¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: $INSTALL_DIR/venv/bin/uvicorn"
    exit 1
fi
```

#### 2. APIæœåŠ¡å¥åº·æ£€æŸ¥é—®é¢˜
**é—®é¢˜æè¿°**: APIå¥åº·æ£€æŸ¥å¯èƒ½å› ç½‘ç»œé…ç½®é—®é¢˜å¤±è´¥
**å…·ä½“è¡¨çŽ°**:
- å¥åº·æ£€æŸ¥ä½¿ç”¨localhostï¼Œä½†æœåŠ¡ç»‘å®šåœ¨::ï¼ˆIPv6ï¼‰
- ç¼ºå°‘å¯¹IPv6è¿žæŽ¥æ€§çš„ä¸“é—¨æ£€æŸ¥
- å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´å¯èƒ½ä¸è¶³

**å½±å“èŒƒå›´**: æœåŠ¡çŠ¶æ€æ£€æµ‹ä¸å‡†ç¡®
**ä¿®å¤å»ºè®®**:
```bash
# æ”¹è¿›å¥åº·æ£€æŸ¥é€»è¾‘
if [[ "${SERVER_HOST}" == "::" ]]; then
    # ä¼˜å…ˆæ£€æŸ¥IPv6ï¼Œå›žé€€åˆ°IPv4
    if ! curl -f http://[::1]:$API_PORT/api/v1/health &>/dev/null; then
        curl -f http://127.0.0.1:$API_PORT/api/v1/health &>/dev/null
    fi
fi
```

#### 3. WEBåº”ç”¨è·¯ç”±é…ç½®é—®é¢˜
**é—®é¢˜æè¿°**: Nginxé…ç½®ä¸­å¯èƒ½å­˜åœ¨è·¯ç”±å†²çª
**å…·ä½“è¡¨çŽ°**:
- APIä»£ç†é…ç½®ä¸ŽPHPå¤„ç†å¯èƒ½å­˜åœ¨å†²çª
- ç¼ºå°‘å¯¹é™æ€æ–‡ä»¶å¤„ç†çš„ä¼˜åŒ–
- å®‰å…¨å¤´é…ç½®å¯èƒ½å½±å“æŸäº›åŠŸèƒ½

**å½±å“èŒƒå›´**: å‰ç«¯é¡µé¢æ— æ³•æ­£å¸¸è®¿é—®æˆ–åŠŸèƒ½å¼‚å¸¸
**ä¿®å¤å»ºè®®**:
```nginx
# ä¼˜åŒ–locationé¡ºåº
location = /api/ {
    # ç²¾ç¡®åŒ¹é…APIè·¯å¾„
    proxy_pass http://backend_api/;
}

location /api/ {
    # å¤„ç†APIå­è·¯å¾„
    proxy_pass http://backend_api/;
}

location ~ \.php$ {
    # PHPå¤„ç†
    fastcgi_pass php_backend;
}
```

### ðŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜

#### 4. ä¾èµ–å…³ç³»å¯åŠ¨é¡ºåºé—®é¢˜
**é—®é¢˜æè¿°**: æœåŠ¡ä¾èµ–å…³ç³»å¯èƒ½å¯¼è‡´å¯åŠ¨å¤±è´¥
**å…·ä½“è¡¨çŽ°**:
- MySQLæœåŠ¡å¯åŠ¨æ—¶é—´å¯èƒ½è¶…è¿‡systemdç­‰å¾…æ—¶é—´
- PHP-FPMæœåŠ¡å¯èƒ½åœ¨åŽç«¯æœåŠ¡å¯åŠ¨å‰æœªå°±ç»ª
- ç¼ºå°‘å¯¹ä¾èµ–æœåŠ¡çŠ¶æ€çš„éªŒè¯

**å½±å“èŒƒå›´**: æœåŠ¡å¯åŠ¨ä¸ç¨³å®š
**ä¿®å¤å»ºè®®**:
```bash
# åœ¨start_services()ä¸­æ·»åŠ ä¾èµ–æ£€æŸ¥
wait_for_mysql() {
    local max_attempts=30
    local attempt=0
    while [[ $attempt -lt $max_attempts ]]; do
        if mysql -u root -e "SELECT 1;" &>/dev/null; then
            return 0
        fi
        sleep 2
        ((attempt++))
    done
    return 1
}
```

#### 5. ç«¯å£å†²çªæ£€æµ‹é—®é¢˜
**é—®é¢˜æè¿°**: ç«¯å£å†²çªæ£€æµ‹å¯èƒ½ä¸å¤Ÿå‡†ç¡®
**å…·ä½“è¡¨çŽ°**:
- netstatå‘½ä»¤åœ¨æŸäº›ç³»ç»Ÿä¸Šå¯èƒ½ä¸å¯ç”¨
- ç«¯å£æ£€æµ‹é€»è¾‘å¯èƒ½é—æ¼æŸäº›æƒ…å†µ
- ç¼ºå°‘å¯¹ç«¯å£èŒƒå›´çš„éªŒè¯

**å½±å“èŒƒå›´**: æœåŠ¡å¯èƒ½å› ç«¯å£å†²çªå¯åŠ¨å¤±è´¥
**ä¿®å¤å»ºè®®**:
```bash
# æ”¹è¿›ç«¯å£æ£€æµ‹é€»è¾‘
check_port_available() {
    local port=$1
    local protocol=${2:-tcp}
    
    # ä½¿ç”¨å¤šç§æ–¹æ³•æ£€æµ‹ç«¯å£
    if command -v ss &> /dev/null; then
        ss -tuln | grep -q ":$port "
    elif command -v netstat &> /dev/null; then
        netstat -tuln | grep -q ":$port "
    else
        # å›žé€€åˆ°telnetæ£€æµ‹
        timeout 1 bash -c "</dev/tcp/localhost/$port" 2>/dev/null
    fi
}
```

#### 6. æƒé™é…ç½®é—®é¢˜
**é—®é¢˜æè¿°**: æ–‡ä»¶æƒé™é…ç½®å¯èƒ½ä¸å¤Ÿç²¾ç¡®
**å…·ä½“è¡¨çŽ°**:
- æ—¥å¿—ç›®å½•æƒé™777å¯èƒ½è¿‡äºŽå®½æ¾
- é…ç½®æ–‡ä»¶æƒé™å¯èƒ½ä¸å¤Ÿå®‰å…¨
- ç¼ºå°‘å¯¹æ•æ„Ÿæ–‡ä»¶çš„ç‰¹æ®Šæƒé™å¤„ç†

**å½±å“èŒƒå›´**: å®‰å…¨é£Žé™©å’ŒåŠŸèƒ½å¼‚å¸¸
**ä¿®å¤å»ºè®®**:
```bash
# ä¼˜åŒ–æƒé™è®¾ç½®
chmod 750 "$FRONTEND_DIR/logs"  # æ›´å®‰å…¨çš„æ—¥å¿—æƒé™
chmod 600 "$INSTALL_DIR/.env"   # çŽ¯å¢ƒæ–‡ä»¶ä»…æ‰€æœ‰è€…å¯è¯»
chmod 644 "$INSTALL_DIR/config/*.json"  # é…ç½®æ–‡ä»¶æƒé™
```

### ðŸŸ¢ ä½Žä¼˜å…ˆçº§é—®é¢˜

#### 7. é”™è¯¯å¤„ç†ä¸å¤Ÿå®Œå–„
**é—®é¢˜æè¿°**: æŸäº›é”™è¯¯æƒ…å†µç¼ºå°‘é€‚å½“çš„å¤„ç†
**å…·ä½“è¡¨çŽ°**:
- æœåŠ¡å¯åŠ¨å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†
- ç¼ºå°‘å¯¹å¸¸è§é—®é¢˜çš„è‡ªåŠ¨ä¿®å¤å°è¯•
- æ—¥å¿—è®°å½•å¯èƒ½ä¸å¤Ÿå®Œæ•´

**å½±å“èŒƒå›´**: é—®é¢˜è¯Šæ–­å›°éš¾
**ä¿®å¤å»ºè®®**:
```bash
# å¢žå¼ºé”™è¯¯å¤„ç†
handle_service_failure() {
    local service_name=$1
    log_error "$service_name å¯åŠ¨å¤±è´¥"
    
    # å°è¯•è‡ªåŠ¨ä¿®å¤
    case $service_name in
        "ipv6-wireguard-manager")
            log_info "å°è¯•ä¿®å¤åŽç«¯æœåŠ¡..."
            # æ£€æŸ¥PythonçŽ¯å¢ƒ
            # æ£€æŸ¥ä¾èµ–
            # é‡æ–°å®‰è£…ä¾èµ–
            ;;
    esac
}
```

#### 8. æ—¥å¿—é…ç½®é—®é¢˜
**é—®é¢˜æè¿°**: æ—¥å¿—é…ç½®å¯èƒ½ä¸å¤Ÿä¼˜åŒ–
**å…·ä½“è¡¨çŽ°**:
- æ—¥å¿—è½®è½¬é…ç½®å¯èƒ½ç¼ºå¤±
- æ—¥å¿—çº§åˆ«å¯èƒ½ä¸å¤Ÿè¯¦ç»†
- ç¼ºå°‘å¯¹æ—¥å¿—æ–‡ä»¶å¤§å°çš„é™åˆ¶

**å½±å“èŒƒå›´**: æ—¥å¿—ç®¡ç†å›°éš¾
**ä¿®å¤å»ºè®®**:
```bash
# æ·»åŠ æ—¥å¿—è½®è½¬é…ç½®
cat > /etc/logrotate.d/ipv6-wireguard-manager << EOF
$INSTALL_DIR/logs/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 644 $SERVICE_USER $SERVICE_GROUP
}
EOF
```

## æ½œåœ¨é£Žé™©åˆ†æž

### 1. æœåŠ¡å¯åŠ¨å¤±è´¥é£Žé™©
**é£Žé™©ç­‰çº§**: é«˜
**å¯èƒ½åŽŸå› **:
- Pythonè™šæ‹ŸçŽ¯å¢ƒé—®é¢˜
- ä¾èµ–åŒ…ç¼ºå¤±
- ç«¯å£å†²çª
- æƒé™ä¸è¶³

**ç¼“è§£æŽªæ–½**:
- æ·»åŠ è¯¦ç»†çš„å¯åŠ¨å‰æ£€æŸ¥
- æä¾›è‡ªåŠ¨ä¿®å¤æœºåˆ¶
- å¢žå¼ºé”™è¯¯è¯Šæ–­ä¿¡æ¯

### 2. ç½‘ç»œè¿žæŽ¥é—®é¢˜
**é£Žé™©ç­‰çº§**: ä¸­
**å¯èƒ½åŽŸå› **:
- IPv6é…ç½®é—®é¢˜
- é˜²ç«å¢™é˜»æ­¢
- ç½‘ç»œæŽ¥å£ç»‘å®šé—®é¢˜

**ç¼“è§£æŽªæ–½**:
- æ·»åŠ ç½‘ç»œè¿žé€šæ€§æµ‹è¯•
- æä¾›IPv4å›žé€€æœºåˆ¶
- å¢žå¼ºç½‘ç»œé…ç½®æ£€æŸ¥

### 3. æ€§èƒ½é—®é¢˜
**é£Žé™©ç­‰çº§**: ä¸­
**å¯èƒ½åŽŸå› **:
- èµ„æºä¸è¶³
- é…ç½®ä¸å½“
- å¹¶å‘å¤„ç†èƒ½åŠ›ä¸è¶³

**ç¼“è§£æŽªæ–½**:
- æ·»åŠ æ€§èƒ½ç›‘æŽ§
- ä¼˜åŒ–é…ç½®å‚æ•°
- æä¾›æ€§èƒ½è°ƒä¼˜å»ºè®®

## ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

### ç«‹å³ä¿®å¤ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
1. åŽç«¯æœåŠ¡å¯åŠ¨æ£€æŸ¥
2. APIå¥åº·æ£€æŸ¥é€»è¾‘
3. WEBåº”ç”¨è·¯ç”±é…ç½®

### è¿‘æœŸä¿®å¤ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
4. ä¾èµ–å…³ç³»å¯åŠ¨é¡ºåº
5. ç«¯å£å†²çªæ£€æµ‹
6. æƒé™é…ç½®ä¼˜åŒ–

### é•¿æœŸä¼˜åŒ–ï¼ˆä½Žä¼˜å…ˆçº§ï¼‰
7. é”™è¯¯å¤„ç†å®Œå–„
8. æ—¥å¿—é…ç½®ä¼˜åŒ–

## æµ‹è¯•éªŒè¯å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•
```bash
# æµ‹è¯•åŽç«¯æœåŠ¡å¯åŠ¨
sudo systemctl start ipv6-wireguard-manager
sudo systemctl status ipv6-wireguard-manager

# æµ‹è¯•APIå¥åº·æ£€æŸ¥
curl -f http://localhost:8000/api/v1/health

# æµ‹è¯•WEBåº”ç”¨è®¿é—®
curl -f http://localhost:80/
```

### 2. åŽ‹åŠ›æµ‹è¯•
```bash
# æµ‹è¯•å¹¶å‘è¿žæŽ¥
ab -n 1000 -c 10 http://localhost:80/

# æµ‹è¯•APIæ€§èƒ½
ab -n 500 -c 5 http://localhost:8000/api/v1/health
```

### 3. æ•…éšœæ¢å¤æµ‹è¯•
```bash
# æµ‹è¯•æœåŠ¡é‡å¯
sudo systemctl restart ipv6-wireguard-manager

# æµ‹è¯•ä¾èµ–æœåŠ¡æ•…éšœ
sudo systemctl stop mysql
sudo systemctl start mysql
```

## ç»“è®º

IPv6 WireGuard ManageråŽŸç”Ÿå®‰è£…å­˜åœ¨ä¸€äº›éœ€è¦å…³æ³¨çš„é—®é¢˜ï¼Œä¸»è¦é›†ä¸­åœ¨æœåŠ¡å¯åŠ¨ã€ç½‘ç»œé…ç½®ã€æƒé™ç®¡ç†ç­‰æ–¹é¢ã€‚å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥ä¿®å¤è¿™äº›é—®é¢˜ï¼Œä»¥æé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚

é€šè¿‡å®žæ–½å»ºè®®çš„ä¿®å¤æŽªæ–½ï¼Œå¯ä»¥æ˜¾è‘—æé«˜åŽŸç”Ÿå®‰è£…çš„æˆåŠŸçŽ‡å’Œè¿è¡Œç¨³å®šæ€§ã€‚
